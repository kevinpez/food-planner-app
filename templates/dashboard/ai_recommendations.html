{% extends "base.html" %}

{% block title %}AI Recommendations - Food Planner{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-robot text-primary me-2"></i>
                AI Recommendations
            </h2>
            <button class="btn btn-primary" onclick="getNewRecommendation()">
                <i class="fas fa-magic me-1"></i>Get New Recommendation
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        {% if recommendations %}
            {% for recommendation in recommendations %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-1">
                                    <span class="badge bg-primary me-2">{{ recommendation.recommendation_type|title }}</span>
                                    {{ recommendation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                </h6>
                            </div>
                            <div class="btn-group btn-group-sm">
                                {% if not recommendation.is_used %}
                                    <button class="btn btn-outline-success" onclick="markAsUsed({{ recommendation.id }})">
                                        <i class="fas fa-check"></i> Mark as Used
                                    </button>
                                {% else %}
                                    <span class="badge bg-success">Used</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <p class="card-text">{{ recommendation.recommendation_text }}</p>
                        
                        {% set context = recommendation.get_context_data() %}
                        {% if context %}
                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>Based on:</strong>
                                    {% if context.get('recent_foods') %}
                                        Recent foods: {{ context.recent_foods[:3]|join(', ') }}{% if context.recent_foods|length > 3 %} and {{ context.recent_foods|length - 3 }} more{% endif %}
                                    {% endif %}
                                    {% if context.get('dietary_restrictions') %}
                                        • Dietary restrictions: {{ context.dietary_restrictions|join(', ') }}
                                    {% endif %}
                                    {% if context.get('calorie_goal') %}
                                        • Calorie goal: {{ context.calorie_goal }}
                                    {% endif %}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-robot fa-5x text-muted mb-4"></i>
                    <h4>No AI Recommendations Yet</h4>
                    <p class="text-muted mb-4">
                        Start logging your meals to get personalized AI recommendations 
                        based on your eating habits and preferences.
                    </p>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button class="btn btn-primary" onclick="getNewRecommendation()">
                            <i class="fas fa-magic me-1"></i>Get Your First Recommendation
                        </button>
                        <a href="{{ url_for('food.log') }}" class="btn btn-outline-primary">
                            <i class="fas fa-plus me-1"></i>Log Some Food First
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <div id="new-recommendations"></div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Recommendation Types
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="getNewRecommendation('meal')">
                        <i class="fas fa-utensils me-2"></i>Meal Suggestions
                    </button>
                    <small class="text-muted">Get suggestions for balanced, healthy meals</small>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-success w-100 mb-2" onclick="getNewRecommendation('snack')">
                        <i class="fas fa-cookie-bite me-2"></i>Healthy Snacks
                    </button>
                    <small class="text-muted">Find nutritious snack options</small>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-outline-info w-100 mb-2" onclick="getNewRecommendation('alternative')">
                        <i class="fas fa-exchange-alt me-2"></i>Food Alternatives
                    </button>
                    <small class="text-muted">Discover healthier alternatives to your favorite foods</small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    How AI Recommendations Work
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-brain text-primary me-2"></i>
                        <small>Analyzes your recent food intake patterns</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-shield-alt text-success me-2"></i>
                        <small>Considers your dietary restrictions and preferences</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-target text-warning me-2"></i>
                        <small>Aligns with your daily calorie goals</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-balance-scale text-info me-2"></i>
                        <small>Focuses on nutritional balance and variety</small>
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-heart text-danger me-2"></i>
                        <small>Promotes overall health and wellness</small>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Your Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="row">
                        <div class="col-6">
                            <h4 class="mb-0">{{ recommendations|length }}</h4>
                            <small class="text-muted">Total Recommendations</small>
                        </div>
                        <div class="col-6">
                            <h4 class="mb-0">{{ recommendations|selectattr('is_used')|list|length }}</h4>
                            <small class="text-muted">Used</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function getNewRecommendation(type = 'meal') {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Getting recommendation...';
    
    try {
        const response = await fetch('/api/ai/recommend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ type: type })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const now = new Date();
            const timeString = now.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            
            const recommendationHtml = `
                <div class="card mb-3 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-1">
                                    <span class="badge bg-primary me-2">${data.recommendation.type}</span>
                                    ${timeString} <span class="badge bg-success ms-2">New</span>
                                </h6>
                            </div>
                            <button class="btn btn-outline-success btn-sm" onclick="markAsUsed(${data.recommendation.id})">
                                <i class="fas fa-check"></i> Mark as Used
                            </button>
                        </div>
                        <p class="card-text">${data.recommendation.text}</p>
                    </div>
                </div>
            `;
            
            const newRecommendationsDiv = document.getElementById('new-recommendations');
            newRecommendationsDiv.innerHTML = recommendationHtml + newRecommendationsDiv.innerHTML;
            
            // Scroll to the new recommendation
            newRecommendationsDiv.scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Error getting AI recommendation: ' + data.message);
        }
    } catch (error) {
        alert('Error getting AI recommendation. Please try again.');
        console.error('Error:', error);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

async function markAsUsed(recommendationId) {
    try {
        const response = await fetch(`/api/ai/recommendation/${recommendationId}/used`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        if (response.ok) {
            // Update the button to show "Used"
            const button = event.target;
            button.outerHTML = '<span class="badge bg-success">Used</span>';
        }
    } catch (error) {
        console.error('Error marking recommendation as used:', error);
    }
}
</script>
{% endblock %}