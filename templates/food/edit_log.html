{% extends "base.html" %}

{% block title %}Edit Food Log - Food Planner{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="fas fa-edit text-primary me-2"></i>
                    Edit Food Log
                </h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>{{ food_log.food.name }}</strong>
                    {% if food_log.food.brand %}
                        <br><small class="text-muted">{{ food_log.food.brand }}</small>
                    {% endif %}
                </div>
                
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity (grams)</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               value="{{ food_log.quantity }}" min="1" step="0.1" required>
                        <div class="form-text">
                            Current: {{ food_log.quantity }}g = {{ "%.0f"|format(food_log.get_calories()) }} calories
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meal_type" class="form-label">Meal Type</label>
                        <select class="form-select" id="meal_type" name="meal_type" required>
                            <option value="breakfast" {{ 'selected' if food_log.meal_type == 'breakfast' }}>Breakfast</option>
                            <option value="lunch" {{ 'selected' if food_log.meal_type == 'lunch' }}>Lunch</option>
                            <option value="dinner" {{ 'selected' if food_log.meal_type == 'dinner' }}>Dinner</option>
                            <option value="snack" {{ 'selected' if food_log.meal_type == 'snack' }}>Snack</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3">{{ food_log.notes or '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <strong>Originally logged:</strong> {{ food_log.logged_at.strftime('%B %d, %Y at %I:%M %p') }}
                        </small>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('food.history') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Nutrition Information</h5>
            </div>
            <div class="card-body">
                {% set nutrition = food_log.food.get_nutrition_data() %}
                {% if nutrition %}
                    <!-- Quality Scores -->
                    {% if nutrition.get('nutri_score_grade') or nutrition.get('nova_group') %}
                        <div class="row mb-3">
                            {% if nutrition.get('nutri_score_grade') %}
                                <div class="col-6">
                                    <div class="text-center">
                                        <span class="badge bg-success fs-6">{{ nutrition.nutri_score_grade }}</span>
                                        <br><small class="text-muted">Nutri-Score</small>
                                    </div>
                                </div>
                            {% endif %}
                            {% if nutrition.get('nova_group') and nutrition.nova_group > 0 %}
                                <div class="col-6">
                                    <div class="text-center">
                                        <span class="badge bg-info fs-6">{{ nutrition.nova_group|int }}</span>
                                        <br><small class="text-muted">NOVA Group</small>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <hr>
                    {% endif %}

                    <!-- Basic Macros -->
                    <div class="row text-center mb-3">
                        {% if nutrition.get('calories_per_100g') %}
                            <div class="col-6 col-md-3 mb-2">
                                <strong>{{ nutrition.calories_per_100g }}</strong>
                                <br><small class="text-muted">Calories/100g</small>
                            </div>
                        {% endif %}
                        
                        {% if nutrition.get('protein_per_100g') %}
                            <div class="col-6 col-md-3 mb-2">
                                <strong>{{ nutrition.protein_per_100g }}g</strong>
                                <br><small class="text-muted">Protein/100g</small>
                            </div>
                        {% endif %}
                        
                        {% if nutrition.get('carbs_per_100g') %}
                            <div class="col-6 col-md-3 mb-2">
                                <strong>{{ nutrition.carbs_per_100g }}g</strong>
                                <br><small class="text-muted">Carbs/100g</small>
                            </div>
                        {% endif %}
                        
                        {% if nutrition.get('fat_per_100g') %}
                            <div class="col-6 col-md-3 mb-2">
                                <strong>{{ nutrition.fat_per_100g }}g</strong>
                                <br><small class="text-muted">Fat/100g</small>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Detailed Fats -->
                    {% if nutrition.get('saturated_fat_per_100g') or nutrition.get('omega_3_per_100g') %}
                        <div class="accordion" id="nutritionAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fatsCollapse">
                                        <i class="fas fa-oil-can me-2"></i>Detailed Fats
                                    </button>
                                </h2>
                                <div id="fatsCollapse" class="accordion-collapse collapse" data-bs-parent="#nutritionAccordion">
                                    <div class="accordion-body">
                                        <div class="row text-center">
                                            {% if nutrition.get('saturated_fat_per_100g') and nutrition.saturated_fat_per_100g > 0 %}
                                                <div class="col-6 col-md-4 mb-2">
                                                    <strong>{{ "%.1f"|format(nutrition.saturated_fat_per_100g) }}g</strong>
                                                    <br><small class="text-muted">Saturated Fat</small>
                                                </div>
                                            {% endif %}
                                            {% if nutrition.get('omega_3_per_100g') and nutrition.omega_3_per_100g > 0 %}
                                                <div class="col-6 col-md-4 mb-2">
                                                    <strong>{{ "%.2f"|format(nutrition.omega_3_per_100g) }}g</strong>
                                                    <br><small class="text-muted">Omega-3</small>
                                                </div>
                                            {% endif %}
                                            {% if nutrition.get('omega_6_per_100g') and nutrition.omega_6_per_100g > 0 %}
                                                <div class="col-6 col-md-4 mb-2">
                                                    <strong>{{ "%.2f"|format(nutrition.omega_6_per_100g) }}g</strong>
                                                    <br><small class="text-muted">Omega-6</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vitamins -->
                            {% if nutrition.get('vitamin_c_per_100g') or nutrition.get('vitamin_d_per_100g') %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vitaminsCollapse">
                                            <i class="fas fa-pills me-2"></i>Vitamins
                                        </button>
                                    </h2>
                                    <div id="vitaminsCollapse" class="accordion-collapse collapse" data-bs-parent="#nutritionAccordion">
                                        <div class="accordion-body">
                                            <div class="row text-center">
                                                {% for vitamin, label in [
                                                    ('vitamin_c_per_100g', 'Vitamin C'),
                                                    ('vitamin_d_per_100g', 'Vitamin D'),
                                                    ('vitamin_a_per_100g', 'Vitamin A'),
                                                    ('vitamin_b12_per_100g', 'Vitamin B12'),
                                                    ('vitamin_e_per_100g', 'Vitamin E')
                                                ] %}
                                                    {% if nutrition.get(vitamin) and nutrition[vitamin] > 0 %}
                                                        <div class="col-6 col-md-4 mb-2">
                                                            <strong>{{ "%.1f"|format(nutrition[vitamin]) }}{{ 'mg' if 'c' in vitamin or 'e' in vitamin else 'μg' }}</strong>
                                                            <br><small class="text-muted">{{ label }}</small>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Minerals -->
                            {% if nutrition.get('calcium_per_100g') or nutrition.get('iron_per_100g') %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mineralsCollapse">
                                            <i class="fas fa-gem me-2"></i>Minerals
                                        </button>
                                    </h2>
                                    <div id="mineralsCollapse" class="accordion-collapse collapse" data-bs-parent="#nutritionAccordion">
                                        <div class="accordion-body">
                                            <div class="row text-center">
                                                {% for mineral, label in [
                                                    ('calcium_per_100g', 'Calcium'),
                                                    ('iron_per_100g', 'Iron'),
                                                    ('potassium_per_100g', 'Potassium'),
                                                    ('magnesium_per_100g', 'Magnesium'),
                                                    ('zinc_per_100g', 'Zinc')
                                                ] %}
                                                    {% if nutrition.get(mineral) and nutrition[mineral] > 0 %}
                                                        <div class="col-6 col-md-4 mb-2">
                                                            <strong>{{ "%.1f"|format(nutrition[mineral]) }}mg</strong>
                                                            <br><small class="text-muted">{{ label }}</small>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Dietary Info -->
                    {% if nutrition.get('is_vegan') or nutrition.get('is_vegetarian') or nutrition.get('is_organic') or nutrition.get('is_gluten_free') %}
                        <hr>
                        <h6>Dietary Information</h6>
                        <div class="row">
                            {% if nutrition.get('is_vegan') %}
                                <div class="col-6 col-md-3 mb-1">
                                    <span class="badge bg-success"><i class="fas fa-leaf me-1"></i>Vegan</span>
                                </div>
                            {% elif nutrition.get('is_vegetarian') %}
                                <div class="col-6 col-md-3 mb-1">
                                    <span class="badge bg-info"><i class="fas fa-seedling me-1"></i>Vegetarian</span>
                                </div>
                            {% endif %}
                            {% if nutrition.get('is_organic') %}
                                <div class="col-6 col-md-3 mb-1">
                                    <span class="badge bg-warning"><i class="fas fa-certificate me-1"></i>Organic</span>
                                </div>
                            {% endif %}
                            {% if nutrition.get('is_gluten_free') %}
                                <div class="col-6 col-md-3 mb-1">
                                    <span class="badge bg-primary"><i class="fas fa-wheat me-1"></i>Gluten-Free</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Allergens -->
                    {% if nutrition.get('allergens') and nutrition.allergens %}
                        <hr>
                        <h6>Allergens</h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {% for allergen in nutrition.allergens %}
                                <span class="badge bg-danger me-1">{{ allergen.replace('en:', '').title() }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted text-center">No detailed nutrition information available</p>
                {% endif %}
                
                {% if food_log.food.ingredients %}
                    <hr>
                    <h6>Ingredients</h6>
                    <p class="small">{{ food_log.food.ingredients }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Update calorie calculation when quantity changes
document.getElementById('quantity').addEventListener('input', function() {
    const quantity = parseFloat(this.value) || 0;
    const caloriesPer100g = {{ nutrition.get('calories_per_100g', 0) }};
    const totalCalories = (caloriesPer100g * quantity) / 100;
    
    const helpText = this.nextElementSibling;
    helpText.textContent = `${quantity}g = ${Math.round(totalCalories)} calories`;
});
</script>
{% endblock %}